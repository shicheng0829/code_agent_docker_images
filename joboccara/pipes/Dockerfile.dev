FROM ubuntu:18.04

# 避免交互式安装
ENV DEBIAN_FRONTEND=noninteractive

# 安装基本依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    g++ \
    clang \
    libc++-dev \
    libc++abi-dev \
    wget \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# 安装CMake 3.12或更高版本
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | apt-key add - && \
    apt-add-repository 'deb https://apt.kitware.com/ubuntu/ bionic main' && \
    apt-get update && \
    apt-get install -y cmake

# 设置工作目录
WORKDIR /app

# 复制源代码
COPY . .

# 构建项目
RUN mkdir build && cd build && cmake -DBUILD_TESTING=ON .. && make

# 运行测试
CMD ["sh", "-c", "cd build && ./tests/pipes_test"]
FROM ubuntu:22.04

# 避免交互式安装
ENV DEBIAN_FRONTEND="noninteractive" TZ="Europe/London"

# 安装必要的系统依赖
RUN apt-get update -y && \
    apt-get install -y apt-utils 2>&1 | grep -v "debconf: delaying package configuration, since apt-utils is not installed" && \
    apt-get install -y --no-install-recommends \
    cmake \
    build-essential \
    python3 \
    python3-dev \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
RUN pip3 install --upgrade pip && \
    pip3 install numpy pyarrow pytest pandas

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY . .

# 创建测试目录
RUN mkdir -p tmp

# 设置环境变量
ENV USTORE_TEST_PATH="/app/tmp/"

# 显示使用说明
RUN echo "# UStore Development Environment" > /app/README.md && \
    echo "" >> /app/README.md && \
    echo "## Building the C++ Extensions" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "To build the C++ extensions required for the Python modules:" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "    pip3 install ." >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "## Running Tests" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "After building the extensions, you can run the tests:" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "    cd python && python3 -m pytest tests/ -v" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "## Interactive Shell" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "To start an interactive shell:" >> /app/README.md && \
    echo "" >> /app/README.md && \
    echo "    docker run -it --rm ustore-dev bash" >> /app/README.md

# 默认命令：显示使用说明
CMD ["bash", "-c", "cat /app/README.md"]
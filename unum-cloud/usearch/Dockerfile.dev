# syntax=docker/dockerfile:1

# Use Ubuntu 24.04 as the base image
FROM ubuntu:24.04
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    nodejs \
    npm \
    clang \
    libomp-dev \
    libjemalloc-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install Go
RUN wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz && \
    rm -rf /usr/local/go && \
    tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"

# Create a virtual environment and activate it
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip
RUN pip install --upgrade pip

# Install Python dependencies
RUN pip install pytest numpy

# Set working directory
WORKDIR /usearch

# Copy the project files
COPY . .

# Initialize submodules
RUN git submodule update --init --recursive

# Build C/C++ components
RUN cmake -B build_artifacts -D CMAKE_BUILD_TYPE=RelWithDebInfo \
    -D USEARCH_BUILD_TEST_CPP=1 \
    -D USEARCH_BUILD_TEST_C=1 \
    -D USEARCH_BUILD_LIB_C=1 \
    -D USEARCH_BUILD_SQLITE=1 \
    -D USEARCH_USE_OPENMP=1 \
    -D USEARCH_USE_SIMSIMD=1 \
    -D USEARCH_USE_JEMALLOC=1 && \
    cmake --build build_artifacts --config RelWithDebInfo

# Install Python package in development mode
RUN pip install -e .

# Install JavaScript dependencies
RUN npm install

# Build JavaScript components
RUN npm run build-js

# Default command to run all tests
CMD ["bash", "-c", "echo 'Running C++ tests...' && \
    ./build_artifacts/test_cpp && \
    ./build_artifacts/test_c && \
    echo 'Running Python tests...' && \
    pytest && \
    echo 'Running JavaScript tests...' && \
    npm test && \
    echo 'Running Rust tests...' && \
    cargo test"]